- name: check repositories
  command: yum repoinfo centos-openshift-origin37
  register: subs_result
  failed_when: disabled
  changed_when: "'This system is not yet registered' in subs_result.stderr"

- name: Install Origin repo
  command: yum -y install centos-release-openshift-origin37
  retries: 5
  delay: 5
  when: subs_result.changed

- name: Ensure that required packages are present on target hosts
  yum:
    name: "{{item}}"
    state: latest
  retries: 5
  delay: 5
  with_items: "{{packages}}"

- name: Install Required Packages
  yum:
    name: "{{item}}"
    state: installed
  with_items: "{{packages}}"

- name: Install required openstack packages for bastion
  yum:
    name: "{{item}}"
    state: installed
    disablerepo: rhel-7-fast-datapath-rpms
    disablerepo: rhel-7-server-ose-{{ openshift_version }}-rpms
  with_items: "{{packages_bastion_openstack}}"

- name: Install required openshift packages for bastion
  yum:
    name: "{{item}}"
    state: installed
    disablerepo: rhel-7-server-openstack-{{ openstack_version }}-tools-rpms
  with_items: "{{packages_bastion_openshift}}"

- name: Copy OpenStack Credentials to Bastion
  copy:
    src: /root/keystonerc_admin
    dest: /home/cloud-user/keystonerc_admin
    mode: 0755
    owner: "{{ ssh_user }}"

- name: Copy OpenStack ssh key to bastion
  copy:
    src: /root/.ssh/id_rsa
    dest: /home/cloud-user/id_rsa
    mode: 0400
    owner: "{{ ssh_user }}"

- name: Copy playbooks to bastion
  copy:
    src: "{{ playbook_dir }}"
    dest: /home/{{ ssh_user }}
    directory_mode: 0755
    mode: 0755
    owner: "{{ ssh_user }}"
    group: "{{ ssh_user }}"
